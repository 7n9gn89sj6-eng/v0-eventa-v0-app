// --------------------------------------------------
// Prisma Client Generator
// --------------------------------------------------
generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"]
}

// --------------------------------------------------
// Database Connection (Render / Neon / Local)
// --------------------------------------------------
datasource db {
  provider     = "postgresql"
  url          = env("DATABASE_URL")  // IMPORTANT: use DATABASE_URL ALWAYS
  relationMode = "prisma"

  extensions   = [vector(schema: "public")]
}

// --------------------------------------------------
// User Model
// --------------------------------------------------
model User {
  id                 String              @id @default(cuid())
  email              String              @unique
  name               String?
  isVerified         Boolean             @default(false)
  emailVerified      DateTime?
  image              String?

  // Admin login fields
  adminPassword      String?
  isAdmin            Boolean             @default(false)

  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt

  accounts           Account[]
  emailVerifications EmailVerification[]
  events             Event[]
  moderatedEvents    Event[]             @relation("ModeratedEvents")
  appeals            EventAppeal[]
  favorites          Favorite[]
  sessions           Session[]
}

// --------------------------------------------------
// OAuth Accounts
// --------------------------------------------------
model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?

  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

// --------------------------------------------------
// Sessions
// --------------------------------------------------
model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime

  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

// --------------------------------------------------
// Email verifications
// --------------------------------------------------
model EmailVerification {
  id         String    @id @default(cuid())
  userId     String
  email      String
  code       String
  expiresAt  DateTime
  consumedAt DateTime?
  createdAt  DateTime  @default(now())

  user       User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([email])
}

// --------------------------------------------------
// NextAuth Verification Token
// --------------------------------------------------
model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// --------------------------------------------------
// Event Model
// --------------------------------------------------
model Event {
  id                   String                 @id @default(cuid())
  title                String
  description          String
  startAt              DateTime
  endAt                DateTime
  locationAddress      String?
  city                 String
  country              String
  imageUrl             String?
  externalUrl          String?
  categories           String[]               @default([])
  timezone             String                 @default("UTC")
  venueName            String?
  address              String?
  lat                  Float?
  lng                  Float?
  priceFree            Boolean                @default(false)
  priceAmount          Int?
  websiteUrl           String?
  languages            String[]               @default(["en"])
  imageUrls            String[]               @default([])
  createdById          String
  createdAt            DateTime               @default(now())
  updatedAt            DateTime               @updatedAt
  searchText           String
  searchTextFolded     String?
  embedding            Unsupported("vector")?
  postcode             String?
  status               EventStatus            @default(DRAFT)
  adminNotes           String?
  aiAnalyzedAt         DateTime?
  aiReason             String?
  aiStatus             AIStatus?              @default(PENDING)
  category             EventCategory?
  editCount            Int                    @default(0)
  extractionConfidence Json?
  lastEditedAt         DateTime?
  moderatedAt          DateTime?
  moderatedBy          String?
  moderationCategory   String?
  moderationReason     String?
  moderationSeverity   ModerationSeverity?
  moderationStatus     ModerationStatus       @default(PENDING)
  organizerContact     String?
  organizerName        String?
  publishedAt          DateTime?
  reviewedAt           DateTime?
  reviewedBy           String?
  sourceText           String?
  tags                 String[]               @default([])

  createdBy            User                   @relation(fields: [createdById], references: [id], onDelete: Cascade)
  moderatedByAdmin     User?                  @relation("ModeratedEvents", fields: [moderatedBy], references: [id])

  appeals              EventAppeal[]
  auditLogs            EventAuditLog[]
  editTokens           EventEditToken[]
  favorites            Favorite[]

  @@index([city, country, startAt])
  @@index([startAt])
  @@index([categories])
  @@index([category])
  @@index([lat, lng])
  @@index([status])
  @@index([aiStatus])
  @@index([createdById])
  @@index([updatedAt])
  @@index([createdAt])
}

// --------------------------------------------------
// Event Edit Tokens
// --------------------------------------------------
model EventEditToken {
  id        String    @id @default(cuid())
  eventId   String
  tokenHash String    @unique
  expires   DateTime
  usedAt    DateTime?
  createdAt DateTime  @default(now())

  event     Event     @relation(fields: [eventId], references: [id], onDelete: Cascade)
}

// --------------------------------------------------
// Favorites
// --------------------------------------------------
model Favorite {
  id        String   @id @default(cuid())
  userId    String
  eventId   String
  createdAt DateTime @default(now())

  event     Event    @relation(fields: [eventId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, eventId])
  @@index([userId])
  @@index([eventId])
}

// --------------------------------------------------
// Event Audit Log
// --------------------------------------------------
model EventAuditLog {
  id        String   @id @default(cuid())
  eventId   String
  actor     String
  actorId   String?
  action    String
  oldStatus String?
  newStatus String?
  notes     String?
  reason    String?
  createdAt DateTime @default(now())

  event     Event    @relation(fields: [eventId], references: [id], onDelete: Cascade)

  @@index([eventId])
  @@index([createdAt])
  @@index([actorId])
}

// --------------------------------------------------
// Event Appeal
// --------------------------------------------------
model EventAppeal {
  id          String    @id @default(cuid())
  eventId     String
  userId      String
  reason      String
  status      String    @default("pending")
  reviewedBy  String?
  reviewedAt  DateTime?
  reviewNotes String?
  createdAt   DateTime  @default(now())

  event       Event     @relation(fields: [eventId], references: [id], onDelete: Cascade)
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([eventId])
  @@index([status])
}

// --------------------------------------------------
// ENUMS
// --------------------------------------------------
enum EventStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
  PENDING
}

enum ModerationStatus {
  PENDING
  APPROVED
  FLAGGED
  REJECTED
}

enum ModerationSeverity {
  LOW
  MEDIUM
  HIGH
}

enum EventCategory {
  ARTS_CULTURE
  MUSIC_NIGHTLIFE
  FOOD_DRINK
  FAMILY_KIDS
  SPORTS_OUTdoors
  COMMUNITY_CAUSES
  LEARNING_TALKS
  MARKETS_FAIRS
  ONLINE_VIRTUAL
}

enum AIStatus {
  PENDING
  SAFE
  NEEDS_REVIEW
  REJECTED
}
